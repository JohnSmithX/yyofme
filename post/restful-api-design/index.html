<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>
	  
	  HTTP API设计 | YY of Me
	  
  </title>
  <link rel="stylesheet" href="//cdn.jsdelivr.net/uikit/2.21.0/css/uikit.min.css">
  
  <link rel="stylesheet" href="http://yyo.me/css/github.css">
  <link rel="stylesheet" href="http://yyo.me/css/style.css">
</head>

<body>
	<div class="uk-block uk-block-large uk-block-muted">
		<div class="uk-container uk-container-center">
			<div class="uk-grid">
				<div class="uk-width-large-1-10 uk-hidden-medium uk-hidden-small"></div>
				<div class="uk-width-large-8-10 uk-width-medium-1-1 uk-width-small-1-1">
          
          <div id="header" class="clearfix">
            <div class="uk-float-left">
              <h2><a href="http://yyo.me/">YY of Me</a></h2>
            </div>
            <div class="uk-float-right">
              <a href="http://yyo.me/" class="uk-button">Home</a>
              
              
                
              
                
              
                
              
                
              
                
                  <a href="http://yyo.me/about/" class="uk-button">About Me</a>
                
              
                
              
            </div>
          </div>
				</div>
				<div class="uk-width-large-1-10 uk-hidden-medium uk-hidden-small"></div>
			</div>
		</div>
	</div>

<div class="uk-block uk-block-default">
	<div class="uk-container uk-container-center">
		<div class="uk-grid">
			<div class="uk-width-large-1-10 uk-hidden-medium uk-hidden-small"></div>
			<div class="uk-width-large-8-10 uk-width-medium-1-1 uk-width-small-1-1">
				<article class="uk-article">
					<h1 class="uk-article-title" style="font-size: 23px;">
						HTTP API设计
					</h1>
					
					<p class="uk-article-meta">Posted on Sat, Aug 2, 2014 |  <a href="http://yyo.me//tags/http" class="uk-button uk-button-mini">#http</a> <a href="http://yyo.me//tags/api" class="uk-button uk-button-mini">#api</a></p>
        <div class="uk-panel uk-panel-box uk-panel-box-primary">
          Unless otherwise indicated, the text of documents in this site is available under the <a href="https://creativecommons.org/licenses/by/3.0/deed">Creative Commons Attribution 3.0 Unported License</a>, or any later version. Copyright 2014-2016 xushuai.
        </div>
					

<h2 id="http-api设计指导:bcda3c781250d2e9b974ed0ba415289b">HTTP API设计指导</h2>

<p>via <a href="https://github.com/interagent/http-api-design">github@geemus</a></p>

<h3 id="介绍:bcda3c781250d2e9b974ed0ba415289b">介绍</h3>

<p>作者的本意是介绍<a href="https://heroku.com/" title="神奇的平台">heroku</a>平台的 <code>http-json</code> API设计 <a href="https://devcenter.heroku.com/articles/platform-api-reference">heroku官方文档</a>
本文意在推荐一套成熟的api设计模式来减少读者在api设计上遇到的坑.无论如何,这篇指导都比较适合
初涉api设计,或者在api设计上遇到瓶颈的同学.学习之-</p>

<h3 id="准备工作:bcda3c781250d2e9b974ed0ba415289b">准备工作</h3>

<h4 id="1-需要tls:bcda3c781250d2e9b974ed0ba415289b">1. 需要tls</h4>

<p>强制依赖tls握手协议,所有不通过tls的请求都视为非法的,阻止并返回 <code>403</code> 错误.不推荐使用重定向动作,
因为重定向行为本身就接受了所有的非法的客户端请求,而且加倍了服务器流量,重定向的请求同样没有通过tls,这
是个非常差的设计.</p>

<h4 id="2-在accepts头参数中表明api的版本:bcda3c781250d2e9b974ed0ba415289b">2. 在accepts头参数中表明api的版本</h4>

<p>不要使用默认的版本,要让客户端请求明确表明它们需要的api版本通过在<code>accepts</code>头参数里面加上版本号.
如:</p>

<pre><code>Accept: application/vnd.heroku+json; version=3
</code></pre>

<h4 id="3-使用etags:bcda3c781250d2e9b974ed0ba415289b">3. 使用Etags</h4>

<p>使用 <code>etag</code> 头参数来缓存数据,客户端只需回传 <code>If-None-Match</code> 验证数据是否过期,这样可以节省服务器资源.</p>

<h4 id="4-通过request-ids追踪请求:bcda3c781250d2e9b974ed0ba415289b">4. 通过Request-Ids追踪请求</h4>

<p>使用 <code>Request-Id</code> 头参数,协助追中和debug请求.</p>

<h4 id="5-content-range标记页码:bcda3c781250d2e9b974ed0ba415289b">5. Content-Range标记页码</h4>

<h3 id="请求-request:bcda3c781250d2e9b974ed0ba415289b">请求 <code>Request</code></h3>

<h4 id="1-使用状态码:bcda3c781250d2e9b974ed0ba415289b">1. 使用状态码</h4>

<p>状态码介绍内容省略,可以通过<a href="google.com">google</a>以及<a href="baidu.com">baidu</a>等搜索出详细介绍.<a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html">HTTP response code spec</a></p>

<h4 id="2-返回完整的资源:bcda3c781250d2e9b974ed0ba415289b">2. 返回完整的资源</h4>

<p>请求成功后(200, 201状态码),尽可能的返回完整的资源.即使是 <code>put/patch</code> 和 <code>delete</code> 请求.
如:</p>

<pre><code>$ curl -X DELETE \  
 https://service.com/apps/1f9b/domains/0fd4
</code></pre>

<pre><code>HTTP/1.1 200 OK
Content-Type: application/json;charset=utf-8
...
{
 &quot;created_at&quot;: &quot;2012-01-01T12:00:00Z&quot;,
 &quot;hostname&quot;: &quot;subdomain.example.com&quot;,
 &quot;id&quot;: &quot;01234567-89ab-cdef-0123-456789abcdef&quot;,
 &quot;updated_at&quot;: &quot;2012-01-01T12:00:00Z&quot;
}
</code></pre>

<pre><code>$ curl -X DELETE \  
 https://service.com/apps/1f9b/dynos/05bd
</code></pre>

<pre><code>HTTP/1.1 202 Accepted
Content-Type: application/json;charset=utf-8
...
{}
</code></pre>

<h4 id="3-接受json参数请求:bcda3c781250d2e9b974ed0ba415289b">3. 接受json参数请求</h4>

<pre><code>$ curl -X POST https://service.com/apps \
    -H &quot;Content-Type: application/json&quot; \
    -d '{&quot;name&quot;: &quot;demoapp&quot;}'
</code></pre>

<pre><code>{
  &quot;id&quot;: &quot;01234567-89ab-cdef-0123-456789abcdef&quot;,
  &quot;name&quot;: &quot;demoapp&quot;,
  &quot;owner&quot;: {
    &quot;email&quot;: &quot;username@example.com&quot;,
    &quot;id&quot;: &quot;01234567-89ab-cdef-0123-456789abcdef&quot;
  },
  ...
}
</code></pre>

<h4 id="4-使用restful的路径格式:bcda3c781250d2e9b974ed0ba415289b">4. 使用restful的路径格式</h4>

<h5 id="资源名:bcda3c781250d2e9b974ed0ba415289b">资源名</h5>

<p>　　
使用资源名词的复数形式,e.g. <code>books, apples, users</code> 但是也存在列外,比如大部分情况下一个 <code>user</code> 只有一个 <code>account</code>
e.g.</p>

<pre><code>/users/:user/account/actions/:action/
</code></pre>

<h5 id="资源操作:bcda3c781250d2e9b974ed0ba415289b">资源操作</h5>

<p>单单展示资源的时候,路径名不需要添加动作,堆资源进行操作的时候需要满足如下规则:</p>

<pre><code>/resources/:resource/actions/:action
</code></pre>

<p>e.g.</p>

<pre><code>/books/{book_id}/actions/delete
</code></pre>

<h4 id="5-路径使用小写字母:bcda3c781250d2e9b974ed0ba415289b">5. 路径使用小写字母</h4>

<p>使用小写字母和破折号标示路径. e.g.</p>

<pre><code>service-api.com/users
service-api.com/app-setups
</code></pre>

<p>json 或者 yaml 字段属性, 使用下划线链接. e.g.</p>

<pre><code>service_class: &quot;first&quot;
</code></pre>

<h4 id="6-路径中资源可以用非id标示:bcda3c781250d2e9b974ed0ba415289b">6. 路径中资源可以用非ID标示</h4>

<p>前面介绍过,资源路径标示. <code>/resources/{resource_id}</code> 但是总会存在,资源标示符未非数字的情况,如: <code>uuid</code>
出现此类情况,可以使用其他标示符填写路径. e.g.</p>

<pre><code>$ curl https://service.com/users/{app_id_or_name}
$ curl https://service.com/users/97addcf0-c182
$ curl https://service.com/users/www-prod
</code></pre>

<p>不要只允许使用IDs标示资源</p>

<h4 id="7-因尽量减少路径的深层次嵌套:bcda3c781250d2e9b974ed0ba415289b">7. 因尽量减少路径的深层次嵌套</h4>

<p>往往会因为数据模型的深层次嵌套导致路径的深层次嵌套. e.g.</p>

<pre><code>/orgs/{org_id}/apps/{app_id}/dynos/{dyno_id}
</code></pre>

<p>这种写法导致路径的理解困难,难读.推荐做法</p>

<pre><code>/orgs/{org_id}
/orgs/{org_id}/apps
/apps/{app_id}
/apps/{app_id}/dynos
/dynos/{dyno_id}
</code></pre>

<p>路径集合也能标示主从关系.并且易读写.</p>

<h3 id="反馈-response:bcda3c781250d2e9b974ed0ba415289b">反馈 <code>Response</code></h3>

<h4 id="1-资源的唯一标示id:bcda3c781250d2e9b974ed0ba415289b">1. 资源的唯一标示ID</h4>

<p>为每个资源创建一个唯一ID. e.g. <code>UUID</code>
不要使用数据表自增长ID作为标示符.并使用小写字母 <code>8-4-4-4-12</code> 格式. e.g.</p>

<pre><code>&quot;id&quot;: &quot;01234567-89ab-cdef-0123-456789abcdef&quot;
</code></pre>

<h4 id="2-记录资源创建和更新时间戳:bcda3c781250d2e9b974ed0ba415289b">2. 记录资源创建和更新时间戳</h4>

<p>提供 <code>created_at</code> 和 <code>updated_at</code> e.g.</p>

<pre><code>{
  ...
  &quot;created_at&quot;: &quot;2014-08-01T12:00:00Z&quot;,
  &quot;updated_at&quot;: &quot;2014-08-01T13:00:00Z&quot;,
  ...
}
</code></pre>

<h4 id="3-使用utc时间和iso8601格式:bcda3c781250d2e9b974ed0ba415289b">3. 使用UTC时间和ISo8601格式</h4>

<p>e.g.</p>

<pre><code>&quot;finished_at&quot;: &quot;2012-01-01T12:00:00Z&quot;
</code></pre>

<h4 id="4-包含并嵌套外键关系:bcda3c781250d2e9b974ed0ba415289b">4. 包含并嵌套外键关系</h4>

<p>使用:</p>

<pre><code>{
  &quot;name&quot;: &quot;service-production&quot;,
  &quot;owner&quot;: {
    &quot;id&quot;: &quot;5d8201b0...&quot;
  },
  ...
}
</code></pre>

<p>而非:</p>

<pre><code>{
  &quot;name&quot;: &quot;service-production&quot;,
  &quot;owner_id&quot;: &quot;5d8201b0...&quot;,
  ...
}
</code></pre>

<p>原因:这样做的目的是为了能够方便的扩展关系资源包含的属性,而不需要修改或引入数据结构</p>

<pre><code>{
  &quot;name&quot;: &quot;service-production&quot;,
  &quot;owner&quot;: {
    &quot;id&quot;: &quot;5d8201b0...&quot;,
    &quot;name&quot;: &quot;Alice&quot;,
    &quot;email&quot;: &quot;alice@heroku.com&quot;
  },
  ...
}
</code></pre>

<h4 id="5-错误数据返回格式应该是经过设计的:bcda3c781250d2e9b974ed0ba415289b">5. 错误数据返回格式应该是经过设计的</h4>

<p>一般包括错误 <code>id</code> 易理解的信息 <code>message</code> 以及一个可以获取解决方案的 <code>url</code>
e.g.</p>

<pre><code>HTTP/1.1 429 Too Many Requests
{
  &quot;id&quot;:      &quot;rate_limit&quot;,
  &quot;message&quot;: &quot;Account reached its API rate limit.&quot;,
  &quot;url&quot;:     &quot;https://docs.service.com/rate-limits&quot;
}
</code></pre>

<h4 id="6-标示请求速率限制状态:bcda3c781250d2e9b974ed0ba415289b">6. 标示请求速率限制状态</h4>

<p>使用 <code>RateLimit-Remaining</code> 头参数,标示当前请求限制状态</p>

<h4 id="7-压缩返回的json文件:bcda3c781250d2e9b974ed0ba415289b">7. 压缩返回的json文件</h4>

<p>去掉不必要的换行符,空格.
使用:</p>

<pre><code>{&quot;beta&quot;:false,&quot;email&quot;:&quot;alice@heroku.com&quot;,&quot;id&quot;:&quot;01234567-89ab-cdef-0123-456789abcdef&quot;,&quot;last_login&quot;:&quot;2012-01-01T12:00:00Z&quot;, &quot;created_at&quot;:&quot;2012-01-01T12:00:00Z&quot;,&quot;updated_at&quot;:&quot;2012-01-01T12:00:00Z&quot;}
</code></pre>

<p>替代:</p>

<pre><code>{
  &quot;beta&quot;: false,
  &quot;email&quot;: &quot;alice@heroku.com&quot;,
  &quot;id&quot;: &quot;01234567-89ab-cdef-0123-456789abcdef&quot;,
  &quot;last_login&quot;: &quot;2012-01-01T12:00:00Z&quot;,
  &quot;created_at&quot;: &quot;2012-01-01T12:00:00Z&quot;,
  &quot;updated_at&quot;: &quot;2012-01-01T12:00:00Z&quot;
}
</code></pre>

<p>但是这并不以为着精简json的内容,更不能通过添加查询参数( <code>?pretty=true</code> ), 或者在 <code>accept</code> 头参数中添加属性( <code>Accept: application/vnd.heroku+json; version=3; indent=4;</code> )</p>

<h3 id="注意:bcda3c781250d2e9b974ed0ba415289b">注意</h3>

<blockquote>
<ol>
<li>提供机器识别的json数据结构. <a href="https://github.com/interagent/prmd">tool prmd</a></li>
<li>提供简单明了的API使用文档,即使这有你一个人使用.</li>
<li>提供可以及时执行的列子.</li>
</ol>

<blockquote>
<pre><code> curl -is https://$TOKEN@service.com/users
</code></pre>
</blockquote>

<ol>
<li>加入change log</li>
</ol>
</blockquote>

<h4 id="声明-转载请注明出处via-xus-https-github-com-johnsmithx:bcda3c781250d2e9b974ed0ba415289b"><strong>声明</strong>:转载请注明出处via<a href="https://github.com/JohnSmithX">xus</a></h4>

				</article>
			</div>
			<div class="uk-width-large-1-10 uk-hidden-medium uk-hidden-small"></div>
		</div>
    <div class="uk-grid">
      <div class="uk-width-1-10"></div>
      <div class="uk-width-8-10">
        
        <div class="uk-panel uk-panel-box uk-panel-box-secondary">
          <h3 class="uk-panel-title">Related Posts</h3>
          
          
          <ul class="uk-list uk-list-striped">
            
              
              
              
            
              
              
              
            
              
              
              
            
              
              
              
            
              
              
              
            
              
              
              
            
          </ul>
        </div>
      </div>
      <div class="uk-width-1-10"></div>
    </div>
    <div class="uk-grid">
      <div class="uk-width-1-10"></div>
      <div class="uk-width-8-10">
        <div id="disqus_thread" data-uk-scrollspy></div>
      </div>
      <div class="uk-width-1-10"></div>
    </div>
	</div>
</div>

	<div id="footer" class="uk-block uk-block-large uk-block-muted" data-uk-scrollspy="{repeat: true, delay: 600}">
		<div class="uk-container uk-container-center">
			<div class="uk-grid">
				<div class="uk-width-large-1-10 uk-hidden-medium uk-hidden-small"></div>
				<div class="uk-width-large-8-10 uk-width-medium-1-1 uk-width-small-1-1">
                  <div class="uk-grid">
                    <div class="uk-width-1-1">
                      &copy; Copyright 2014-2016  xushuai
                    </div>
                    <div class="uk-width-1-1">
                      Powered by <a href="http://gohugo.io">Hugo</a> | Themed by <a href="https://github.com/leopku/hugo-theme-next">NeXT</a>
                    </div>
                  </div>
				</div>
				<div class="uk-width-large-1-10 uk-hidden-medium uk-hidden-small"></div>
			</div>
		</div>
	</div>

	<script src="//cdn.jsdelivr.net/jquery/1.11.3/jquery.min.js"></script>
	<script src="//cdn.jsdelivr.net/uikit/2.21.0/js/uikit.min.js"></script>
	<script src="http://yyo.me/js/highlight.pack.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>



<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', '', 'auto');
ga('send', 'pageview');
</script>







</body>
</html>



<script type="text/javascript">

(function() {

  if (window.location.hostname == "localhost") { return; };

  var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    ds_loaded = false;
  var disqus_shortname = 'yyofme';
    disqus_url = 'http:\/\/yyo.me\/post\/restful-api-design\/';
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';

  $('[data-uk-scrollspy]').on('init.uk.scrollspy', function () {
    if (!ds_loaded){
      ds_loaded = true;
      document.getElementById('disqus_thread').appendChild(dsq);
    }
  })

})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

